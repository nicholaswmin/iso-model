<!--
`iso-model`
Isomorphic data models via web-sockets

@demo demo/index.html
-->

<dom-module id="iso-model">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'iso-model',

      properties: {
        suspendedEmit: {
          type: Boolean,
          value: true,
          readOnly: true
        },

        data: {
          type: Object,
          value: null,
          notify: true
        }
      },

      observers: [
        '_determineOperation(data.*)'
      ],

      attached: function() {
        window.isoModel = this

        this.socket = io('http://localhost:2000')
        this.socket.on('initialize', data => {
          this._setSuspendedEmit(true)
          this.set('data', data)
          this._setSuspendedEmit(false)
        })

        this.socket.on('operation', payload => {
          this.applyOperation(payload.operation, payload.data)
        })
      },

      _determineOperation: function(changes) {
        if (changes.path.includes('.splices')) {
          const path = changes.path.replace(/data./g,'').replace(/.splices/g,'')
          const indexSplices = changes.value.indexSplices[0]

          if (indexSplices.addedCount) {
            // PUSH
            const key = indexSplices.addedKeys[0]
            const item = this.get(['data.' + path, key])
            this.emit('push', { path, item })
          } else if (indexSplices.removed) {
            // SPLICE
            const from = indexSplices.index
            const to = indexSplices.removed.length

            this.emit('splice', { path, from, to })
          }
        } else {
          // SET
          if (changes.path.includes('.length') || !changes.base) return
          const value = changes.value
          let path

          if (changes.path.includes('#')) {
            // DEEP SET
            const key = +changes.path.split('#').pop().split('.').shift()
            const parts = changes.path.split('.')
            const keyIndex = parts.indexOf('#' + key)
            const changedArrName = parts[keyIndex - 1]
            const collection = Polymer.Collection.get(changes.base[changedArrName])
            const changedItem = collection.getItem(`#${key}`)
            const changedIndex = changes.base[changedArrName].indexOf(changedItem)

            path = `${changedArrName}.${changedIndex}.${parts.pop()}`

          } else {
            // REGULAR SET
            path = changes.path.replace(/data./g,'').replace(/#/g,'')
          }

          this.emit('set', { path, value })
        }
      },

      emit: function(operation, data) {
        if (this.suspendedEmit) return
        console.info('emitting operation:', operation)

        this.socket.emit('operation', { operation, data })
      },

      applyOperation: function(operation, data) {
        console.info('applying operation:', operation)

        this._setSuspendedEmit(true)

        switch (operation) {
          case 'set':
            this.set(`data.${data.path}`, data.value)
            break;

          case 'push':
            this.push(`data.${data.path}`, data.item)
            break;

          case 'splice':
            this.splice(`data.${data.path}`, data.from, data.to)
            break;
          default:
            console.warn('Cannot determine operation', operation)
        }

        this._setSuspendedEmit(false)
      }
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.slim.js"></script>
</dom-module>
